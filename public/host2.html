<html>

<head>
	<title>Lagless audio host</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.0/socket.io.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.3.0/simplepeer.min.js"></script>
	<script src="https://webrtcexperiment-webrtc.netdna-ssl.com/BandwidthHandler.js"></script>
</head>

<body>

	<script>
		// https://stackoverflow.com/questions/16712224/how-to-control-bandwidth-in-webrtc-video-call


		// example:
// 		var bandwidth = {
// 			screen: 300, // 300kbits minimum
// 			audio: 50,   // 50kbits  minimum
// 			video: 256   // 256kbits (both min-max)
// 		};
// 		var isScreenSharing = false;

// 		sdp = BandwidthHandler.setApplicationSpecificBandwidth(sdp, bandwidth, isScreenSharing);
// 		sdp = BandwidthHandler.setVideoBitrates(sdp, {
// 			min: bandwidth.video,
// 			max: bandwidth.video
// 		});
// 		sdp = BandwidthHandler.setOpusAttributes(sdp);
// 		sdp = BandwidthHandler.setOpusAttributes(sdp, {
// 			'stereo': 0, // to disable stereo (to force mono audio)
// 			'sprop-stereo': 1,
// 			'maxaveragebitrate': 500 * 1024 * 8, // 500 kbits
// 			'maxplaybackrate': 500 * 1024 * 8, // 500 kbits
// 			'cbr': 0, // disable cbr
// 			'useinbandfec': 1, // use inband fec
// 			'usedtx': 1, // use dtx
// 			'maxptime': 3
// 		});

		function mySDPTransform(sdp) {
// 			sdp = BandwidthHandler.setOpusAttributes(sdp, {
// 				'stereo': 0, // to disable stereo (to force mono audio)
// 				'sprop-stereo': 1,
// 				'maxaveragebitrate': 500 * 1024 * 8, // 500 kbits
// 				'maxplaybackrate': 500 * 1024 * 8, // 500 kbits
// 				'cbr': 0, // disable cbr
// 				'useinbandfec': 1, // use inband fec
// 				'usedtx': 1, // use dtx
// 				'maxptime': 3
// 			});

			var bandwidth = {
				screen: 300, // 300kbits minimum
				audio: 500,	// 500kbits  minimum
				video: 256, // 256kbits (both min-max)
			};
			var isScreenSharing = false;

			sdp = BandwidthHandler.setApplicationSpecificBandwidth(sdp, bandwidth, isScreenSharing);
			sdp = BandwidthHandler.setVideoBitrates(sdp, {
				min: bandwidth.video,
				max: bandwidth.video,
			});
			let audioParams = {
				stereo: 0,// to disable stereo (to force mono audio)
				"sprop-stereo": 1,
				useinbandfec: 1,// use inband fec
				usedtx: 1,// use dtx
				maxptime: 3,
				cbr: 0,// disable cbr
				maxaveragebitrate: (500 * 1024 * 8),// 500 kbits
				maxplaybackrate: (500 * 1024 * 8),

			};
			sdp = BandwidthHandler.setOpusAttributes(sdp, audioParams);

			return sdp;
		}

		let socket = io("https://remotegames.io", {
			path: "/8100/socket.io/",
		});

		socket.emit("join", "audioHost");
		setInterval(function() {
			socket.emit("join", "audioHost");
		}, 5000);

		let clients = [];
		let localStream;

		function Client(id, peer) {
			this.id = id;
			this.peer = peer;
			return this;
		}

		function findClientByID(id) {
			let index = -1;
			for (let i = 0; i < clients.length; i++) {
				if (clients[i].id == id) {
					index = i;
					return index;
				}
			}
			return index;
		}


		// get video/voice stream
		navigator.getUserMedia({
			video: false,
			audio: true,
		}, gotMedia, () => {});

		function gotMedia(stream) {
			localStream = stream;
		}


		socket.on("createNewPeer", (data) => {

			let id = data.id;

			let peer = new SimplePeer({
				initiator: true,
				trickle: true,
				stream: localStream,
				sdpTransform: mySDPTransform,
			});

			peer.on("error", (error) => {
				console.log("error", error)
			});

			peer.on("signal", (data) => {
				console.log("SIGNAL", JSON.stringify(data));
				console.log(id);
				let obj = {
					id: id,
					data: JSON.stringify(data),
				};
				socket.emit("hostPeerSignalReply", obj);
			});

			peer.on("connect", () => {
				console.log("CONNECT");
				peer.send(Math.random());
			});

			peer.on("data", (data) => {
				console.log("data: " + data)
			});

			let client = Client(id, peer);
			clients.push(client);
		});

		socket.on("clientPeerSignal", (data) => {
			let index = findClientByID(data.id);
			if (index == -1) {
				return;
			}
			clients[index].peer.signal(JSON.parse(data.data));
		});

		// todo: remove disconnected peers somehow
		// 		setTimeout(function() {

		// 		});
	</script>
</body>

</html>
